(()=>{"use strict";var e,t,a,n,s,r={658:(e,t,a)=>{a.d(t,{A5:()=>l,AE:()=>w,AF:()=>b,BQ:()=>u,M5:()=>p,NC:()=>c,Ns:()=>h,Ve:()=>x,Vz:()=>o,Zn:()=>d,c8:()=>s,gT:()=>T,gk:()=>m,jN:()=>n,k0:()=>r,m3:()=>v,mq:()=>S,y0:()=>y,zO:()=>E});class n{constructor(){this.bindings={}}bind(e,t,a,n){return"string"!=typeof t&&(n=a,a=t,t="change"),document.getElementById(e).addEventListener(t,(t=>{t.preventDefault();try{a(t),"function"==typeof this.onchange&&this.onchange(e)}catch(e){alert(e)}}),!1),this.bindings[e]=n,this}update(){for(let e in this.bindings){let t=this.bindings[e];"function"==typeof t&&t(document.getElementById(e))}return this}}function s(e){return e>=0?1+e/100:1/(1-e/100)}function r(e){return e>=1?100*(e-1):100*(1-1/e)}const i=/^\s*(0x[0-9a-f]+|\d+)\s*([,=:])\s*(0x[0-9a-f]+|\d+)\s*$/i;function o(e){var t=e.match(i);if(t){let e=parseInt(t[1]),a=parseInt(t[3]);if(isFinite(e)&&isFinite(a))switch(t[2]){case",":return[e,e+a];case":":return[e,a]}}}function l(e){var t=e.match(i);if(t){let e=parseInt(t[1]),a=parseInt(t[3]);if(isFinite(e)&&isFinite(a))switch(t[2]){case",":case"=":return[e,a]}}}function c(e,t){var a=e.toString(16);return t-=a.length,"0".repeat(t>=0?t:0)+a}function u(e){return document.getElementById(e)}function d(e,t,a){e.addEventListener(t,a,!1)}function p(e,t,a){e.removeEventListener(t,a,!1)}const h={UP:1,RIGHT:2,DOWN:4,LEFT:8},{abs:f}=Math;function m(e,t,a,n){var s=null;const{UP:r,RIGHT:i,DOWN:o,LEFT:l}=h;function c(e){e.preventDefault(),s=null}function u(e){var u=e.changedTouches;if(null!=s&&1===u.length&&u[0].identifier===s.id){let{screenX:d,screenY:p}=u[0],h=d-s.x,m=p-s.y,b=f(h),v=f(m);if(b>a||v>a){let a=0;b*=2,v*=2,-m>b?a=r:h>v?a=i:m>b?a=o:-h>v&&(a=l),c(e),0!=(a&t)&&n(a)}else e.preventDefault()}else c(e)}d(e,"touchstart",(function(e){var t=e.changedTouches;if(e.preventDefault(),1===t.length&&null==s){let e=t[0];s={id:e.identifier,x:e.screenX,y:e.screenY}}else c(e)})),d(e,"touchcancel",c),d(e,"touchmove",u),d(e,"touchend",(function(e){u(e),s=null}))}function b(){const e=document.createElement("a");return document.body.appendChild(e),e.style="display: none",function(t,a,n){var s=new Blob([t],{type:a}),r=URL.createObjectURL(s);e.href=r,e.download=n,e.click(),URL.revokeObjectURL(r)}}function v(e,t,a){a?e.attachDevice(t):e.detachDevice(t)}function y(e,t){return fetch(e).then((a=>{if(a.ok)return t?a.text():a.arrayBuffer().then((e=>new Uint8Array(e)));throw"Error loading from: "+e}))}const k=/#fresh(?:#|$)/,g="SPECTRUSTY:";function w(e,t){const a=window.localStorage;var n=0;return function(s){var r=s.timeStamp;if(null!=a&&r>n+1e3){n=r;const s=t.cache,i=window.location.pathname,o=g+"i"+i,l=g+"v"+i;if(k.test(s))a.removeItem(o),a.removeItem(l);else{let t=e.toJSON();a.setItem(o,s),a.setItem(l,t)}}}}function T(e,t){const a=window.localStorage,n=t.cache,s=window.location.pathname,r=g+"i"+s,i=g+"v"+s;if(null!=a&&!k.test(n)&&n===a.getItem(r)){let t=a.getItem(i);if(null!=t)try{return e.parseJSON(t),!0}catch(e){console.error(e)}}return!1}function x(e){const{width:t,height:a}=e,n=e.getContext("2d"),s=t/8,r=a/8;for(let[e,i]of["#D80000","#D8D800","#00D800","#00D8D8"].entries())n.beginPath(),n.moveTo((4+e)*s,a),n.lineTo(t,(4+e)*r),n.lineTo(t,(5+e)*r),n.lineTo((5+e)*s,a),n.fillStyle=i,n.strokeStyle=i,n.fill(),n.stroke();n.font="48px sans-serif",n.textBaseline="middle",n.textAlign="end",n.fillStyle="#D8D8D8",n.fillText("S P E C T ",t/2,a/2),n.textAlign="start",n.fillStyle="#880000",n.fillText("R U S T Y",t/2,a/2)}function S(){var e=u("alert");try{if(void 0===window.WebAssembly)throw Error("required browser with WebAssembly support");if("function"!=typeof window.requestAnimationFrame)throw Error("required browser with requestAnimationFrame support");if("function"!=typeof window.fetch)throw Error("required browser with fetch support");if("function"!=typeof window.TextDecoder)throw Error("required browser with TextDecoder support");if("function"!=typeof window.ImageBitmap)throw Error("required browser with ImageBitmap support")}catch(e){throw"required browser with "===e.message.substr(0,22)&&(u("alert-feature").innerHTML="<strong>"+e.message.substr(22).split(" ",1)[0]+"</strong>"),e}e.parentElement.removeChild(e)}function E(){return performance.now()}}},i={};function o(e){var t=i[e];if(void 0!==t)return t.exports;var a=i[e]={id:e,loaded:!1,exports:{}};return r[e](a,a.exports,o),a.loaded=!0,a.exports}o.m=r,e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",a="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",n=e=>{e&&!e.d&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},o.a=(s,r,i)=>{var o;i&&((o=[]).d=1);var l,c,u,d=new Set,p=s.exports,h=new Promise(((e,t)=>{u=t,c=e}));h[t]=p,h[e]=e=>(o&&e(o),d.forEach(e),h.catch((e=>{}))),s.exports=h,r((s=>{var r;l=(s=>s.map((s=>{if(null!==s&&"object"==typeof s){if(s[e])return s;if(s.then){var r=[];r.d=0,s.then((e=>{i[t]=e,n(r)}),(e=>{i[a]=e,n(r)}));var i={};return i[e]=e=>e(r),i}}var o={};return o[e]=e=>{},o[t]=s,o})))(s);var i=()=>l.map((e=>{if(e[a])throw e[a];return e[t]})),c=new Promise((t=>{(r=()=>t(i)).r=0;var a=e=>e!==o&&!d.has(e)&&(d.add(e),e&&!e.d&&(r.r++,e.push(r)));l.map((t=>t[e](a)))}));return r.r?c:i()}),(e=>(e?u(h[a]=e):c(p),n(o)))),o&&(o.d=0)},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,a)=>(o.f[a](e,t),t)),[])),o.u=e=>e+".index.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},o.l=(e,t,a,n)=>{if(s[e])s[e].push(t);else{var r,i;if(void 0!==a)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var u=l[c];if(u.getAttribute("src")==e){r=u;break}}r||(i=!0,(r=document.createElement("script")).charset="utf-8",r.timeout=120,o.nc&&r.setAttribute("nonce",o.nc),r.src=e),s[e]=[t];var d=(t,a)=>{r.onerror=r.onload=null,clearTimeout(p);var n=s[e];if(delete s[e],r.parentNode&&r.parentNode.removeChild(r),n&&n.forEach((e=>e(a))),t)return t(a)},p=setTimeout(d.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=d.bind(null,r.onerror),r.onload=d.bind(null,r.onload),i&&document.head.appendChild(r)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.v=(e,t,a,n)=>{var s=fetch(o.p+""+a+".module.wasm");return"function"==typeof WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(s,n).then((t=>Object.assign(e,t.instance.exports))):s.then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,n))).then((t=>Object.assign(e,t.instance.exports)))},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var a=t.getElementsByTagName("script");a.length&&(e=a[a.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={179:0};o.f.j=(t,a)=>{var n=o.o(e,t)?e[t]:void 0;if(0!==n)if(n)a.push(n[2]);else{var s=new Promise(((a,s)=>n=e[t]=[a,s]));a.push(n[2]=s);var r=o.p+o.u(t),i=new Error;o.l(r,(a=>{if(o.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var s=a&&("load"===a.type?"missing":a.type),r=a&&a.target&&a.target.src;i.message="Loading chunk "+t+" failed.\n("+s+": "+r+")",i.name="ChunkLoadError",i.type=s,i.request=r,n[1](i)}}),"chunk-"+t,t)}};var t=(t,a)=>{var n,s,[r,i,l]=a,c=0;if(r.some((t=>0!==e[t]))){for(n in i)o.o(i,n)&&(o.m[n]=i[n]);l&&l(o)}for(t&&t(a);c<r.length;c++)s=r[c],o.o(e,s)&&e[s]&&e[s][0](),e[s]=0},a=self.webpackChunk=self.webpackChunk||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})(),(()=>{var e=o(658);const t={m:"model",i:"interlace",b:"border",j:"joystick",k:"keyboard",t:"tapChunk"},a={tf:"fastTape",ti:"instantTape",ta:"audibleTape",km:"kempstonMouse"};class n{constructor(){const e=location.hash;this.options=s(e),this.scr=null,this.tap=null,this.snap=null,this.cache=e}hashChanged(){const e=location.hash;if(e!=this.cache)return this.options=s(e),this.cache=e,this.options}mergeAll(e){var t=[];const a=this.options,n=a.ay||(a.ay={});null==a.model&&t.push("models"),null==a.interlace&&t.push("interlace"),null==a.border&&t.push("borders"),null==a.joystick&&t.push("joysticks"),null==a.fastTape&&t.push("fast-tape"),null==a.instantTape&&t.push("instant-tape"),null==a.audibleTape&&t.push("audible-tape"),null==a.kempstonMouse&&t.push("kempston-mouse"),null==n.melodik&&t.push("ay-melodik"),null==n.fuller&&t.push("ay-fuller-box"),null==n.amps&&t.push("ay-amps"),null==n.channels&&t.push("ay-channels"),t.forEach((t=>this.updateFrom(e,t))),this.updateLocation()}updateAll(e){["models","interlace","borders","joysticks","fast-tape","instant-tape","audible-tape","ay-amps","ay-channels"].forEach((t=>this.updateFrom(e,t))),this.updateLocation()}updateFrom(e,t){const a=this.options,n=a.ay||(a.ay={});switch(t){case"models":a.model=l(e.model),["ay-melodik","ay-fuller-box","kempston-mouse"].forEach((t=>this.updateFrom(e,t)));case"keyboard-issue":a.keyboard=(s=e.keyboardIssue).startsWith("Issue")?l(s):"";break;case"interlace":a.interlace=e.interlace;break;case"borders":a.border=function(e){return c[e]||"6"}(e.borderSize);break;case"joysticks":a.joystick=function(e){return u[e]||""}(e.joystick);break;case"fast-tape":a.fastTape=e.fastTape;break;case"instant-tape":a.instantTape=e.instantTape;break;case"audible-tape":a.audibleTape=e.audibleTape;break;case"ay-melodik":n.melodik=e.hasDevice("Melodik");break;case"ay-fuller-box":n.fuller=e.hasDevice("Fuller Box");break;case"kempston-mouse":a.kempstonMouse=e.hasDevice("Kempston Mouse");break;case"ay-amps":n.amps=e.ayAmps.toLowerCase();break;case"ay-channels":n.channels=e.ayChannels;break;case"files":this.removeTap();break;case"reset-hard":case"reset-soft":case"reset-power":case"trigger-nmi":this.removeSnap();break;case"tap-eject":this.removeTap();case"tap-chunks":{let[t,n]=e.tapeProgress();t<0?delete a.tapChunk:a.tapChunk=""+t;break}default:return!1}var s;return!0}updateLocation(){const e=function(e){var n="";for(let a in t){let s=e[t[a]];s&&(n+=`#${a}=${s}`)}for(let t in a){let s=e[a[t]];null!=s&&(n+=`#${t}=${s?"1":"0"}`)}n+=function(e){var t=["amps","channels","melodik","fuller"].filter((t=>!!e[t])).map((t=>{let a=e[t];return"string"==typeof a?a:t})).join(",");return t?`#ay=${t}`:""}(e.ay||{});let s=e.tap;if(s)for(let e of s)n+=`#tap=${e}`;let r=e.snap;r&&(n+=`#${r.type}=${r.url}`);let i=e.scr;return i&&(n+=`#scr=${i}`),n}(this.options);this.cache=e,location.hash=e}applyTo(t){const{model:a,interlace:n,border:s,joystick:r,keyboard:o,fastTape:l,instantTape:c,audibleTape:u,kempstonMouse:d,ay:p,tapChunk:h}=this.options;a&&i((()=>t.selectModel(a))),i((()=>t.interlace=0|n)),i((()=>t.selectBorderSize(s||"full"))),i((()=>t.selectJoystick(function(e){switch(e.toLowerCase()){case"k":case"kempston":return 0;case"f":case"fuller":return 1;case"sr":case"sinclair right":return 2;case"sl":case"sinclair left":return 3;case"c":case"cursor":case"protek":case"agf":return 4;default:{let t=parseInt(e);return t>=0&&t<=4?t:-1}}}(r||"")))),t.keyboardIssue.startsWith("Issue")&&i((()=>t.keyboardIssue="Issue "+(o||"3"))),t.fastTape=null==l||l,t.instantTape=null==c||c,t.audibleTape=null==u||u,(0,e.m3)(t,"Kempston Mouse",d);let{amps:f,melodik:m,fuller:b,channels:v}=p||{};(0,e.m3)(t,"Melodik",m),(0,e.m3)(t,"Fuller Box",b),i((()=>t.ayAmps=f||"Spec")),i((()=>t.ayChannels=(v||"ACB").toUpperCase())),null!=h&&i((()=>t.selectTapeChunk(h)))}removeTap(){delete this.options.tap,this.tap=null}removeSnap(){delete this.options.snap,this.snap=null,delete this.options.scr,this.scr=null}modifiedTap(){const e=this.options.tap;var t=e!=this.tap;return this.tap=e||null,t}modifiedSnap(){var e=!0;const t=this.options.snap;return t?(this.snap&&(e=t.type!==this.snap.type||t.url!==this.snap.url),e&&(this.snap={type:t.type,url:t.url})):(e=!!this.snap,this.snap=null),e}modifiedScr(){const e=this.options.scr;var t=e!=this.scr;return this.scr=e||null,t&&!!e}}function s(e){var n,s={};for(let i of e.split("#")){let e=i.indexOf("="),o=i.substr(0,e).toLowerCase(),l=i.substr(e+1);switch(o){case"ay":s.ay=r(l.split(","));break;case"scr":s.scr=l;break;case"tap":s.tap||(s.tap=n=[]),n.push(l);break;case"sna":case"z80":case"json":s.snap={type:o,url:l};break;default:let e=t[o];e?s[e]=l:(e=a[o],e&&(s[e]=""!=l&&"0"!=l))}}return s}function r(e){var t={};for(let a of e)switch(a=a.toLowerCase()){case"fuse":case"spec":t.amps=a;break;case"melodik":case"fuller":t[a]=!0;break;case"mono":t.channels=a;default:/^[abc]{3}$/.test(a)&&(t.channels=a.toUpperCase())}return t}function i(e){try{e()}catch(e){alert(e)}}function l(e){return e.substr(e.lastIndexOf(" ")+1)}const c={full:"6",large:"5",medium:"4",small:"3",tiny:"2",minimal:"1",none:"0"},u={Kempston:"k",Fuller:"f","Sinclair Right":"sr","Sinclair Left":"sl",Cursor:"c"},d=[[35,27,19,11,3,4,12,20,28,36],[34,26,18,10,2,5,13,21,29,37],[33,25,17,9,1,6,14,22,30,38],[32,24,16,8,0,7,15,23,31,39]],p=d.reduce(((e,t)=>e+t.length),0),h=new Array(p);d.forEach(((e,t)=>e.forEach(((e,a)=>{h[e]=function(e,t){var a,n,s=47;const r=new Path2D;switch(e){case 0:n=27,a=12+65*t;break;case 1:n=92,a=44+65*t;break;case 2:n=158,a=60+65*t;break;default:switch(n=223,t){case 0:a=12,s=63;break;case 9:a=614,s=78;break;default:a=94+65*(t-1)}}return r.rect(a,n,s,32),r}(t,a)}))));class f{constructor(e,t){this.canvas=e,this.state=new Array(p).fill(!1),this.lastMouseKey=null,this.pendingTouches=new Map,e.width=704,e.height=281,this.ctx=e.getContext("2d",{alpha:!1,desynchronized:!0});const a=new Image(e.width,e.height);a.onload=()=>{e.width=a.naturalWidth,e.height=a.naturalHeight,this.keyboard=a,this.redraw()},a.src=t}bind(t){if("function"==typeof t){if("function"!=typeof this.onkey){const t=this.canvas;(0,e.Zn)(t,"mousedown",(e=>m.call(this,e,!0))),(0,e.Zn)(t,"mouseup",(e=>m.call(this,e,!1))),(0,e.Zn)(t,"mouseout",(e=>m.call(this,e,!1))),(0,e.Zn)(t,"touchstart",(e=>b.call(this,e))),(0,e.Zn)(t,"touchmove",(e=>b.call(this,e))),(0,e.Zn)(t,"touchend",(e=>v.call(this,e))),(0,e.Zn)(t,"touchcancel",(e=>v.call(this,e)))}this.onkey=t}}update(e){for(var t=this.state,a=e>>>0,n=0,s=32;;s=p){for(;n<s;++n)t[n]=!0&a,a>>>=1;if(n>=p)break;a=e/4294967296>>>0}return this}redraw(){const e=this.keyboard;if(!e)return;const t=this.state,a=this.ctx;a.globalAlpha=1,a.drawImage(e,0,0),a.globalAlpha=.5,a.fillStyle="blue";for(var n=0;n<p;++n)t[n]&&a.fill(h[n])}}function m(e,t){var a;const n=(e,t)=>{this.state[e]=t,this.onkey(e,t)};if(t?(null!=this.lastMouseKey&&(n(this.lastMouseKey,!1),this.lastMouseKey=null),a=y(e.offsetX,e.offsetY,this.canvas)):a=this.lastMouseKey,null==a)return;const s=32===a&&!this.state[31]||31===a&&!this.state[32];!t&&s||(t&&this.state[a]&&(t=!1),this.lastMouseKey=t&&!s?a:null,n(a,t),t||(32!==a&&this.state[32]&&n(32,!1),31!==a&&this.state[31]&&n(31,!1)),this.redraw())}function b(e){const t=this.canvas,a=e.changedTouches,n=this.pendingTouches;e.preventDefault();var s=!1;for(let e=0;e<a.length;++e){let r=a[e],i=r.identifier,o=y(r.clientX-t.offsetLeft,r.clientY-t.offsetTop,t),l=n.get(i);o!=l&&(null!=o?(n.set(i,o),this.state[o]=!0,this.onkey(o,!0)):n.delete(i),null!=l&&(this.state[l]=!1,this.onkey(l,!1)),s=!0)}s&&this.redraw()}function v(e){const t=e.changedTouches,a=this.pendingTouches;e.preventDefault();for(let e=0;e<t.length;++e){let n=t[e].identifier,s=a.get(n);null!=s&&(a.delete(n),this.state[s]=!1,this.onkey(s,!1))}this.redraw()}function y(e,t,a){const{width:n,height:s,clientWidth:r,clientHeight:i}=a,o=n/r,l=s/i;return o>l?(e*=o,t=t*o-(o*i-s)/2):(e=e*l-(l*r-n)/2,t*=l),function(e,t){if(t>0)if(t<74){if(e>=1&&e<651)return d[0][(e-1)/65|0]}else if(t<135){if(e>=35&&e<685)return d[1][(e-35)/65|0]}else if(t<203){if(e>=52&&e<702)return d[2][(e-52)/65|0]}else if(t<267&&e>0){if(e<85)return d[3][0];if(e<605)return d[3][1+((e-85)/65|0)];if(e<=700)return d[3][9]}}(e,t)}(0,e.mq)(),(0,e.Ve)((0,e.BQ)("main-screen")),$((()=>{$("[title]").tooltip()})),o.e(235).then(o.bind(o,235)).then((t=>{t.setPanicHook();const a=new n,s=new t.ZxSpectrumEmu(.11,a.options.model||"+2B"),r=new f((0,e.BQ)("spectrum-keyboard"),"images/keyboard48.jpg"),i=(0,e.BQ)("main-screen"),o=(0,e.BQ)("main-container"),l=(0,e.BQ)("spectrum-container"),c=((0,e.BQ)("controls"),(0,e.BQ)("tape-name")),u=(0,e.BQ)("tap-chunks"),d=(0,e.BQ)("tape-progress"),p=(0,e.BQ)("tap-play"),h=(0,e.BQ)("tap-record"),m=(0,e.BQ)("pause-resume"),b=(0,e.BQ)("files"),v=((0,e.BQ)("speed-control"),(0,e.BQ)("speed-current")),y=(0,e.BQ)("intro-modal"),k=(0,e.AF)(),g=(0,e.AE)(s,a);var w=!1,T=new ImageData(1,1);const x=new e.jN;function S(){$(y).modal({keyboard:!1})}x.onchange=e=>{a.updateFrom(s,e)&&a.updateLocation()},(0,e.Zn)(window,"hashchange",(e=>{a.hashChanged()&&Y(!1).then((()=>x.update()))})),x.bind("main-screen","click",Z).bind("menu-title","click",Z).bind("menu-hover","mouseover",O).bind("pause-resume","click",Q).bind("turbo",(e=>s.turbo=e.target.checked),(e=>e.checked=s.turbo)).bind("sound-gain","input",(e=>s.gain=e.target.value),(e=>e.value=s.gain)).bind("models",(e=>{s.selectModel(e.target.value),x.update()}),(e=>e.value=s.model)).bind("borders",(e=>s.selectBorderSize(e.target.value)),(e=>e.value=s.borderSize)).bind("interlace",(e=>s.interlace=e.target.selectedIndex),(e=>e.selectedIndex=s.interlace)).bind("joysticks",(e=>s.selectJoystick(e.target.selectedIndex-1)),(e=>e.value=s.joystick)).bind("reset-hard","click",(e=>{s.reset(!0),z()})).bind("reset-soft","click",(e=>{s.reset(!1),z()})).bind("reset-power","click",(e=>{s.powerCycle(),z()})).bind("trigger-nmi","click",(e=>{s.triggerNmi(),z()})).bind("ay-fuller-box",U,W).bind("ay-melodik",U,W).bind("kempston-mouse",U,W).bind("audible-tape",(e=>s.audibleTape=e.target.checked),(e=>e.checked=s.audibleTape)).bind("fast-tape",(e=>s.fastTape=e.target.checked),(e=>e.checked=s.fastTape)).bind("instant-tape",(e=>s.instantTape=e.target.checked),(e=>e.checked=s.instantTape)).bind("files","input",(e=>{J(e.target.files),e.target.value=""})).bind("tap-play","click",(e=>H(s.togglePlayTape()))).bind("tap-record","click",(e=>H(s.toggleRecordTape()))).bind("tap-download","click",(e=>{var t;(t=s.tapeData())&&k(t,"octet/stream",c.value||"new tape.tap")})).bind("tap-chunks","input",(e=>{s.selectTapeChunk(e.target.selectedIndex),X()}),(e=>{V(s.tapeInfo()),H(s.tapeStatus())})).bind("tap-eject","click",(e=>{s.ejectTape(),b.value=c.value="",V(s.tapeInfo()),H(s.tapeStatus())})).bind("ay-amps",(e=>s.ayAmps=e.target.value),(e=>e.value=s.ayAmps)).bind("ay-channels",(e=>s.ayChannels=e.target.value),(e=>e.value=s.ayChannels)).bind("speed-reset","click",(function(){G(0),x.update()})).bind("speed-control","input",(e=>G(e.target.value)),(t=>{var a=s.cpuRateFactor;t.value=(0,e.k0)(a),v.value="x"+a.toFixed(2)})).bind("toggle-keyboard","click",N).bind("keyboard-issue",(e=>s.keyboardIssue=e.target.value),(e=>{e.value=s.keyboardIssue,e.disabled=!e.value})).bind("save-z80v3","click",(e=>te(3))).bind("save-z80v2","click",(e=>te(2))).bind("save-z80v1","click",(e=>te(1))).bind("save-sna","click",(e=>{return t=s.saveSNA(),void k(t,"octet/stream","spectrusty.sna");var t})).bind("save-scr","click",(e=>{return t=s.snapScr(),void k(t,"octet/stream","spectrusty.scr");var t})).bind("save-snapshot","click",(e=>{return t=s.toJSON(),void k(t,"json","spectrusty.json");var t})).bind("poke-memory","click",(t=>{var a=prompt("POKE");if(a)if(a=(0,e.A5)(a)){let[e,t]=a;s.poke(e,t)}else alert("Please provide address and the value in a valid format.\nE.g.:\n0x4000, 0xff\n0x4000=0xff\n16384, 255\n16384=255")})).bind("peek-memory","click",(e=>{var t=prompt("PEEK");if(t){let e=parseInt(t);if(isFinite(e)){let e=s.peek(t);alert("PEEK "+t+": "+e+" (0x"+e.toString(16)+")")}else alert("Please provide a single address in the range: [0, 65535] or [0x0, 0xFFFF]")}})).bind("dump-memory","click",(e=>ee("Dump memory range at:","octet/stream","memory","bin",((e,t)=>s.dump(e,t))))).bind("disasm-memory","click",(e=>ee("Disassemble memory range at:","text/plain","z80asm","txt",((e,t)=>s.disassemble(e,t))))),$(y).on("hide.bs.modal",(e=>{w&&Q()})).on("show.bs.modal",(e=>{w||Q()})),(0,e.Zn)(document,"keydown",(e=>{if(!e.repeat)switch(e.code){case"F1":e.preventDefault(),S();break;case"F2":case"F3":case"F4":case"F5":case"F6":case"F7":case"F8":e.preventDefault(),N();break;case"F9":case"F10":case"F11":case"F12":break;case"Pause":Q();break;case"Escape":o.classList.toggle("show-panel");break;default:s.updateStateFromKeyEvent(e,!0),r.update(s.keyboard).redraw()}})),(0,e.Zn)(document,"keyup",(e=>{s.updateStateFromKeyEvent(e,!1),r.update(s.keyboard).redraw()})),r.bind(((e,t)=>s.setKeyState(e,t))),(0,e.Zn)(i,"click",I);const E=j(!0),F=j(!1);function I(e){s.hasDevice("Kempston Mouse")&&i.requestPointerLock()}function A(e){s.moveMouse(e.movementX,e.movementY)}function j(e){return t=>s.updateMouseButton(t.button,e)}(0,e.Zn)(document,"pointerlockchange",(t=>{const a=document.pointerLockElement===i,n=a?e.Zn:e.M5,s=a?e.M5:e.Zn;n(i,"mousemove",A),n(i,"mousedown",E),n(i,"mouseup",F),s(i,"click",I)})),(0,e.Zn)(window,"pagehide",g),(0,e.Zn)(window,"unload",g),(0,e.Zn)(window,"visibilitychange",(e=>{document.hidden&&g(e)}));const{LEFT:P,RIGHT:C,UP:B,DOWN:D}=e.Ns;function L(e){switch(e){case C:O();break;case P:Z();break;case B:l.classList.add("show-keyboard");break;case D:l.classList.remove("show-keyboard")}}(0,e.gk)(i,C|P|B|D,50,L),(0,e.gk)((0,e.BQ)("menu-title"),P,20,L),c.value="";const M=i.getContext("2d",{alpha:!1,desynchronized:!0});function O(){o.classList.add("show-panel")}function Z(){o.classList.remove("show-panel")}function N(){l.classList.toggle("show-keyboard")}function z(){return w?Q():Promise.resolve()}function Q(){return w="Pause"==m.value,m.disabled=!0,(w?s.pauseAudio():s.resumeAudio()).then((()=>{m.value=w?"Resume":"Pause",m.disabled=!1}))}function R(e){if(w)return Promise.resolve(!1);let t=s.runFramesWithAudio(e);if(null==t)return Promise.resolve(!1);{let{width:e,height:a,data:n}=s.renderVideo();if(e!==T.width||a!==T.height){let[t,n]=s.canvasSize;i.width=t,i.height=n,T=new ImageData(e,a)}return T.data.set(n),createImageBitmap(T).then((e=>(M.drawImage(e,0,0,i.width,i.height),e.close(),t)))}}function _(){R(performance.now()).then(q)}function K(e){R(e).then(q)}function q(e){e&&x.update(),o.classList.contains("show-panel")&&h.disabled&&X(),s.turbo?setTimeout(_,0):requestAnimationFrame(K)}function U(t){(0,e.m3)(s,t.target.name,t.target.checked)}function W(e){e.checked=s.hasDevice(e.name)}function H(e){switch(e){case 0:p.value="Play",p.disabled=!1,h.value="Record",h.disabled=!1,u.disabled=!1;break;case 1:p.value="Pause",p.disabled=!1,h.value="Record",h.disabled=!0,u.disabled=!0;break;case 2:p.value="Play",p.disabled=!0,h.value="Stop",h.disabled=!1,u.disabled=!0}X()}function J(e,t){if((t|=0)<e.length){let n=e.item(t),r=n.name,i=r.toLowerCase().substring(r.lastIndexOf(".")),o=new FileReader;o.onloadend=function(){var n=o.result;"string"!=typeof n&&(n=new Uint8Array(n));try{switch(i){case".tap":c.value=r,V(0==t?s.insertTape(n):s.appendTape(n)),setTimeout((()=>J(e,t+1)),0);break;case".scr":s.showScr(n);break;case".sna":s.loadSna(n),c.value="";break;case".z80":s.loadZ80(n),c.value="";break;case".json":s.parseJSON(n),c.value="";break;default:alert("Unsupported file type.")}}catch(e){alert(e)}x.update(),a.updateAll(s)},".json"===i?o.readAsText(n):o.readAsArrayBuffer(n)}}function Y(t){var n,r,i=Promise.resolve("fresh");if(t&&(0,e.gT)(s,a))t=!1,i=Promise.resolve("continue");else if(a.modifiedSnap()){let o=a.snap;o&&(t=!1,i=(n=o.url,r=o.type,(0,e.y0)(n,"json"===r).then((e=>{switch(r){case"sna":s.loadSna(e);break;case"z80":s.loadZ80(e);break;case"json":s.parseJSON(e);break;default:return}c.value="",a.mergeAll(s)})).catch((e=>alert(e)))).then((()=>"run")))}if(a.modifiedTap()){let n=a.tap;i=i.then((r=>{return(i=n,Promise.allSettled((i||[]).map((t=>(0,e.y0)(t,!1)))).then((e=>{var t;for(let a of e)if("fulfilled"===a.status){let e=a.value;t=t?s.appendTape(e):s.insertTape(e)}else alert(a.reason);t||(s.ejectTape(),t=s.tapeInfo()),V(t),b.value=c.value="",H(s.tapeStatus())})).catch((e=>alert(e)))).then((()=>(a.applyTo(s),n&&t&&(s.resetAndLoad(),r="run"),r)));var i}))}else i=a.modifiedScr()?i.then((n=>function(t){return(0,e.y0)(t,!1).then((e=>(s.showScr(e),!0))).catch((e=>alert(e)))}(a.scr).then((e=>(a.applyTo(s),e&&t&&(s.resetAndHalt(),n="halt"),n))))):i.then((e=>(a.applyTo(s),e)));return i.catch((e=>alert(e)))}function V(e){var t=0,a=u.options;for(let{info:n,size:s}of e){let e=a.item(t++);null==e&&(e=document.createElement("option"),u.appendChild(e)),e.value=s,e.text=n}a.length=t,X()}function X(){var[e,t]=s.tapeProgress();u.selectedIndex,u.selectedIndex=e;var a=u.selectedOptions.item(0);if(a){let e=0|a.value;d.value=e-t,d.max=e}else d.value=0,d.max=0}function G(t){let a=(0,e.c8)(t);v.value="x"+a.toFixed(2),s.setCpuRateFactor(a)}function ee(t,a,n,s,r){var i=prompt(t);if(i)if(i=(0,e.Vz)(i)){let[t,o]=i;try{let i=r(t,o);k(i,a,`${n}-0x${(0,e.NC)(65535&t,4)}-0x${(0,e.NC)(65535&o,4)}.${s}`)}catch(e){alert(e)}}else alert("Please provide address range in a valid format.\nE.g.:\n0x4000:0x4100\n0x4000, 0x100\n16384:16640\n16384, 256")}function te(e){var t=s.saveZ80(e);k(t,"octet/stream","spectrusty.z80")}M.imageSmoothingEnabled=!1,Y(!0).then((e=>{"fresh"!==e&&"continue"!==e||O(),"fresh"===e||"run"===e?Q().then(S):"halt"===e&&setTimeout(Q,50),q(!0)}))})).catch(console.error)})()})();